<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>短信转发器Web客户端</title>
    <style>
        /* 全局样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fb 100%);
            min-height: 100vh;
            padding: 20px 0;
            color: #333;
        }
        
        /* 主容器样式 */
        .main-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            width: 90%;
            max-width: 600px;
            margin: 0 auto;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* 标题栏样式 */
        .header {
            background: linear-gradient(135deg, #4299e1 0%, #38b2ac 100%);
            color: white;
            padding: 20px 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 内容区域样式 */
        .content {
            padding: 25px;
        }
        
        /* 登录状态样式 */
        .login-status {
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-status i {
            margin-right: 8px;
        }
        
        .status-connected {
            background: #e8f4f8;
            color: #4299e1;
        }
        
        .status-disconnected {
            background: #fdf2f8;
            color: #e53e3e;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            color: #2d3748;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        
        /* 单选框组样式 */
        .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .radio-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .radio-option input {
            display: none;
        }
        
        .radio-option span {
            font-size: 15px;
            color: #4a5568;
        }
        
        .radio-option:hover {
            background: #f8f8f8;
        }
        
        .radio-option.active {
            background: #e8f4f8;
            border-color: #4299e1;
            color: #4299e1;
            font-weight: 600;
        }
        
        .radio-option.active span {
            color: #4299e1;
            font-weight: 600;
        }
        
        /* 按钮样式 */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4299e1 0%, #38b2ac 100%);
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.2);
        }
        
        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 响应结果样式 */
        .response-section {
            margin-top: 25px;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .response-title {
            font-weight: 600;
            color: #4a5568;
            font-size: 16px;
        }
        
        .result-container {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid #e2e8f0;
        }
        
        /* JSON高亮样式 */
        .json-key { color: #92278f; font-weight: 600; }
        .json-string { color: #25aae2; }
        .json-number { color: #f7941d; }
        .json-boolean { color: #00b42a; }
        .json-null { color: #a8a8a8; }
        .json-indent { margin-left: 20px; }
        .json-brace { color: #333; font-weight: 600; }
        
        /* 短信和通话记录卡片样式 */
        .record-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e8f4f8;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .record-content {
            color: #2d3748;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .record-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #718096;
        }
        
        .record-sim {
            background: #e8f4f8;
            color: #4299e1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .record-action {
            color: #4299e1;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
        }
        
        .record-action:hover {
            text-decoration: underline;
        }
        
        /* 配置卡片样式 */
        .config-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .config-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e8f4f8;
        }
        
        .config-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .status-item.active {
            background: #e8f4f8;
            color: #4299e1;
        }
        
        .status-item.inactive {
            background: #f8f8f8;
            color: #a0a0a0;
        }
        
        .status-item i {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .status-item span {
            font-size: 12px;
            font-weight: 600;
        }
        
        /* SIM卡样式 */
        .sim-cards {
            display: grid;
            gap: 12px;
        }
        
        .sim-card {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4299e1;
        }
        
        .sim-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .sim-header i {
            color: #4299e1;
        }
        
        .sim-header span {
            font-weight: 600;
            color: #2d3748;
        }
        
        .sim-number {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 4px;
        }
        
        .sim-icc {
            font-size: 12px;
            color: #718096;
        }
        
        /* 电池卡片样式 */
        .battery-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .battery-level {
            margin-bottom: 20px;
        }
        
        .battery-progress {
            position: relative;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .battery-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }
        
        .battery-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            font-size: 14px;
        }
        
        .battery-details {
            display: grid;
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #718096;
            font-size: 14px;
        }
        
        .detail-value {
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }
        
        /* 定位卡片样式 */
        .location-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .location-details {
            display: grid;
            gap: 12px;
        }
        
        .location-details .detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: none;
            padding: 8px 0;
        }
        
        /* 联系人卡片样式 */
        .contact-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e8f4f8;
        }
        
        .contact-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .contact-number {
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .contact-actions {
            display: flex;
            gap: 15px;
        }
        
        /* 加载更多样式 */
        .load-more {
            text-align: center;
            padding: 12px;
            color: #718096;
            font-size: 13px;
            background: #f8f8f8;
            border-top: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .load-more:hover {
            background: #f0f8fb;
            color: #4299e1;
        }
        
        .load-more.loading {
            color: #4299e1;
        }
        
        .load-more.end {
            color: #a0a0a0;
            cursor: default;
            background: #f8f8f8;
        }
        
        /* 功能区显隐控制 */
        #loginForm, #functionArea {
            display: block;
        }
        
        #functionArea {
            display: none;
        }
        
        /* 媒体查询 */
        @media (max-width: 480px) {
            .main-container {
                width: 95%;
            }
            
            .content {
                padding: 18px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        /* 宫格样式 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .grid-item {
            background: #f0f8fb;
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .grid-item:hover {
            background: #e8f4f8;
            transform: translateY(-2px);
        }
        
        .grid-item.active {
            background: #e8f4f8;
            border-color: #4299e1;
            box-shadow: 0 4px 8px rgba(66, 153, 225, 0.1);
        }
        
        .grid-item i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
            color: #4299e1;
        }
        
        .grid-item span {
            font-size: 13px;
            color: #2d3748;
            font-weight: 600;
            display: block;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>短信转发器Web客户端</h1>
            <p>远程控制您的短信转发器设备</p>
        </div>
        
        <div class="content">
            <!-- 登录状态提示 -->
            <div class="login-status status-disconnected" id="loginStatus">
                <i class="fas fa-plug"></i> 未登录
            </div>
            
            <!-- 登录表单 -->
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="url">服务地址:</label>
                    <input type="text" id="url" name="url" class="form-control" value="" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="key">签名密钥:</label>
                    <input type="password" id="key" name="key" class="form-control" required>
                </div>
                <button type="button" id="loginButton" class="btn btn-primary" onclick="login()">登录</button>
            </form>
            
            <!-- 功能区域 -->
            <div id="functionArea">
                <form id="apiForm">
                    <div class="form-group">
                        <label class="form-label">功能列表:</label>
                        <div id="endpointGrid" class="grid-container">
                            <!-- 功能宫格动态生成 -->
                        </div>
                    </div>
                    <!-- 动态表单字段容器 -->
                    <div id="dynamicFields"></div>
                    <button type="button" id="sendButton" class="btn btn-primary" onclick="sendRequest()">发送请求</button>
                </form>
                
                <!-- 响应结果区域 -->
                <div class="response-section">
                    <div class="response-header">
                        <span class="response-title">响应结果</span>
                    </div>
                    <div id="response" class="result-container"></div>
                    <div class="load-more" id="loadMore" style="display: none;">
                        <span id="loadMoreText">加载更多</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let loginData = null; 
        let currentPage = 1;
        let hasMoreData = true;
        let isLoading = false;
        let currentEndpoint = '';
        let allResults = []; 
        let queryParams = {}; 
        
        // 登录函数
        async function login() {
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');
            const loginStatus = document.getElementById('loginStatus');
            
            if (!loginForm.checkValidity()) {
                loginForm.reportValidity();
                return;
            }
            
            const url = document.getElementById('url').value;
            const key = document.getElementById('key').value;
            const timestamp = Date.now();
            
            loginButton.disabled = true;
            loginButton.innerText = '登录中...';
            loginStatus.className = 'login-status status-disconnected';
            loginStatus.innerHTML = '<i class="fas fa-sync-alt"></i> 正在登录...';
            
            try {
                const sign = await generateSign(timestamp, key);
                const requestBody = { data: {}, timestamp, sign };
                
                const response = await fetch(url + '/config/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: JSON.stringify(requestBody)
                });
                
                const responseData = await response.json();
                
                if (responseData.code === 200) {
                    loginData = responseData.data;
                    loginStatus.className = 'login-status status-connected';
                    loginStatus.innerHTML = `<i class="fas fa-check-circle"></i> 已登录: ${loginData.extra_device_mark || '设备'}`;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('functionArea').style.display = 'block';
                    populateEndpointGrid();
                } else {
                    loginStatus.className = 'login-status status-disconnected';
                    loginStatus.innerHTML = `<i class="fas fa-times-circle"></i> 登录失败: ${responseData.msg || '未知错误'}`;
                }
            } catch (error) {
                loginStatus.className = 'login-status status-disconnected';
                loginStatus.innerHTML = `<i class="fas fa-times-circle"></i> 登录失败: ${error.message}`;
            } finally {
                loginButton.disabled = false;
                loginButton.innerText = '登录';
            }
        }
        
        // 填充功能宫格
        function populateEndpointGrid() {
            const endpointGrid = document.getElementById('endpointGrid');
            endpointGrid.innerHTML = '';
            
            const allEndpoints = [
                { value: '/clone/pull', label: '拉取配置', icon: 'fas fa-download', configKey: 'enable_api_clone' },
                { value: '/clone/push', label: '推送配置', icon: 'fas fa-upload', configKey: 'enable_api_clone' },
                { value: '/sms/send', label: '发送短信', icon: 'fas fa-comment-dots', configKey: 'enable_api_sms_send' },
                { value: '/sms/query', label: '查询短信', icon: 'fas fa-history', configKey: 'enable_api_sms_query' },
                { value: '/call/query', label: '查询通话', icon: 'fas fa-phone', configKey: 'enable_api_call_query' },
                { value: '/battery/query', label: '查询电量', icon: 'fas fa-battery-full', configKey: 'enable_api_battery_query' },
                { value: '/wol/send', label: '远程WOL', icon: 'fas fa-power-off', configKey: 'enable_api_wol' },
                { value: '/location/query', label: '查询定位', icon: 'fas fa-map-marker-alt', configKey: 'enable_api_location' },
                { value: '/contact/add', label: '添加联系人', icon: 'fas fa-user-plus', configKey: 'enable_api_contact_query' },
                { value: '/contact/query', label: '查询联系人', icon: 'fas fa-address-book', configKey: 'enable_api_contact_query' },
                { value: '/config/query', label: '查询配置', icon: 'fas fa-cog' }
            ];
            
            allEndpoints.forEach(endpoint => {
                if (!loginData || loginData[endpoint.configKey] !== false) {
                    const gridItem = document.createElement('div');
                    gridItem.className = 'grid-item';
                    gridItem.dataset.value = endpoint.value;
                    gridItem.innerHTML = `<i class="${endpoint.icon}"></i><span>${endpoint.label}</span>`;
                    gridItem.addEventListener('click', () => {
                        selectGridItem(gridItem);
                        updateFormFields(endpoint.value);
                    });
                    endpointGrid.appendChild(gridItem);
                    
                    // 默认选中第一个
                    if (endpointGrid.children.length === 1) {
                        selectGridItem(gridItem);
                        updateFormFields(endpoint.value);
                    }
                }
            });
        }
        
        // 选中宫格项
        function selectGridItem(item) {
            document.querySelectorAll('.grid-item').forEach(i => {
                i.classList.remove('active');
            });
            item.classList.add('active');
            currentEndpoint = item.dataset.value;
        }
        
        // 更新表单字段
        function updateFormFields(endpoint) {
            const dynamicFields = document.getElementById('dynamicFields');
            dynamicFields.innerHTML = '';
            const fields = getFieldsForEndpoint(endpoint);
            
            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                createField(formGroup, field);
                dynamicFields.appendChild(formGroup);
            });
            
            currentPage = 1;
            hasMoreData = true;
            isLoading = false;
            allResults = [];
            queryParams = {};
            document.getElementById('loadMore').style.display = 'none';
        }
        
        // 获取功能对应的表单字段
        function getFieldsForEndpoint(endpoint) {
            const endpointFields = {
                '/clone/pull': [{ name: 'version_code', type: 'number', label: '客户端App版本号', required: true, defaultValue: '' }],
                '/clone/push': [{ name: 'config_data', type: 'textarea', label: '配置数据(JSON 格式)', required: true, defaultValue: '{}' }],
                '/sms/send': [
                    { name: 'sim_slot', type: 'radio', options: [{ value: '1', label: 'SIM卡1' }, { value: '2', label: 'SIM卡2' }], required: true, defaultValue: '1' },
                    { name: 'phone_numbers', type: 'text', label: '接收手机号码，多个用半角分号分隔', required: true, defaultValue: '' },
                    { name: 'msg_content', type: 'textarea', label: '短信内容', required: true, defaultValue: '' }
                ],
                '/sms/query': [
                    { name: 'type', type: 'radio', options: [{ value: '1', label: '接收' }, { value: '2', label: '发送' }], required: true, defaultValue: '1' },
                    { name: 'page_num', type: 'number', label: '页码', required: true, defaultValue: '1' },
                    { name: 'page_size', type: 'number', label: '分页大小', required: true, defaultValue: '20' },
                    { name: 'keyword', type: 'text', label: '关键字（模糊匹配短信内容）', required: false, defaultValue: '' }
                ],
                '/call/query': [
                    { name: 'type', type: 'radio', options: [{ value: '1', label: '呼入' }, { value: '2', label: '呼出' }, { value: '3', label: '未接' }], required: false, defaultValue: '3' },
                    { name: 'page_num', type: 'number', label: '页码', required: true, defaultValue: '1' },
                    { name: 'page_size', type: 'number', label: '分页大小', required: true, defaultValue: '20' },
                    { name: 'phone_number', type: 'text', label: '手机号码（模糊匹配）', required: false, defaultValue: '' }
                ],
                '/wol/send': [
                    { name: 'mac', type: 'text', label: '网卡MAC地址(例:24:5E:BE:0C:45:9A)', required: true, defaultValue: '' },
                    { name: 'ip', type: 'text', label: '内网IP地址(可选)', required: false, defaultValue: '' },
                    { name: 'port', type: 'number', label: '端口号(可选，默认:9)', required: false, defaultValue: '9' }
                ],
                '/contact/add': [
                    { name: 'phone_number', type: 'text', label: '多个手机号用半角分号分隔', required: true },
                    { name: 'name', type: 'text', label: '通讯录显示名称', required: false }
                ]
            };
            return endpointFields[endpoint] || [];
        }
        
        // 创建表单字段
        function createField(container, field) {
            if (field.type === 'radio') {
                const radioGroup = document.createElement('div');
                radioGroup.className = 'radio-group';
                container.appendChild(radioGroup);
                
                field.options.forEach(option => {
                    const radioOption = document.createElement('div');
                    radioOption.className = 'radio-option';
                    
                    const fieldInput = document.createElement('input');
                    fieldInput.type = 'radio';
                    fieldInput.id = field.name + '_' + option.value;
                    fieldInput.name = field.name;
                    fieldInput.value = option.value;
                    fieldInput.checked = option.value === field.defaultValue;
                    
                    const radioLabel = document.createElement('span');
                    radioLabel.htmlFor = fieldInput.id;
                    radioLabel.innerText = option.label;
                    
                    radioOption.appendChild(fieldInput);
                    radioOption.appendChild(radioLabel);
                    radioGroup.appendChild(radioOption);
                    
                    // 添加点击事件处理
                    radioOption.addEventListener('click', () => {
                        // 取消选中其他选项
                        radioGroup.querySelectorAll('input').forEach(input => {
                            input.checked = false;
                        });
                        // 选中当前选项
                        fieldInput.checked = true;
                        // 更新样式
                        updateRadioStyles(radioGroup);
                    });
                });
                
                // 初始化样式
                updateRadioStyles(radioGroup);
            } else {
                const fieldLabel = document.createElement('label');
                fieldLabel.className = 'form-label';
                fieldLabel.htmlFor = field.name;
                fieldLabel.innerText = field.label;
                container.appendChild(fieldLabel);
                
                const fieldInput = field.type === 'textarea' ? document.createElement('textarea') : document.createElement('input');
                fieldInput.type = field.type === 'textarea' ? 'text' : field.type;
                fieldInput.className = 'form-control';
                fieldInput.id = field.name;
                fieldInput.name = field.name;
                fieldInput.required = field.required;
                fieldInput.value = field.defaultValue || '';
                container.appendChild(fieldInput);
            }
        }
        
        // 更新单选框样式
        function updateRadioStyles(radioGroup) {
            radioGroup.querySelectorAll('.radio-option').forEach(option => {
                const input = option.querySelector('input');
                if (input.checked) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }
        
        // 发送请求
        async function sendRequest(reset = true) {
            const form = document.getElementById('apiForm');
            const sendButton = document.getElementById('sendButton');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            if (reset) {
                currentPage = 1;
                hasMoreData = true;
                allResults = [];
                document.getElementById('response').innerHTML = '';
            }
            
            if (isLoading || !hasMoreData) return;
            
            const url = document.getElementById('url').value;
            const key = document.getElementById('key').value;
            const endpoint = currentEndpoint;
            const timestamp = Date.now();
            let data = {};
            
            if (endpoint === '/clone/push') {
                const configData = document.getElementById('config_data').value;
                try {
                    data = JSON.parse(configData);
                } catch (error) {
                    renderJsonResponse('Error: 配置数据不是有效的JSON格式');
                    return;
                }
            } else {
                const dynamicFields = document.getElementById('dynamicFields').querySelectorAll('input, textarea');
                dynamicFields.forEach(field => {
                    if (field.type === 'radio' && !field.checked) return;
                    data[field.name] = field.value;
                });
            }
            
            if (reset) queryParams = { ...data };
            data.page_num = currentPage;
            
            if (reset) {
                sendButton.disabled = true;
                sendButton.innerText = '请求发送中...';
            }
            
            const loadMoreElement = document.getElementById('loadMore');
            const loadMoreText = document.getElementById('loadMoreText');
            if (['/sms/query', '/call/query'].includes(endpoint)) {
                loadMoreElement.style.display = 'block';
                loadMoreText.innerText = '加载中...';
                loadMoreElement.classList.add('loading');
                isLoading = true;
            }
            
            try {
                const sign = await generateSign(timestamp, key);
                const requestBody = { data, timestamp, sign };
                
                const response = await fetch(url + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: JSON.stringify(requestBody)
                });
                
                const responseData = await response.json();
                
                if (responseData.code === 200) {
                    if (['/sms/query', '/call/query'].includes(endpoint)) {
                        if (responseData.data.length < parseInt(data.page_size)) {
                            hasMoreData = false;
                            loadMoreText.innerText = '没有更多数据了';
                            loadMoreElement.classList.add('end');
                        } else {
                            loadMoreText.innerText = '加载更多';
                            loadMoreElement.classList.remove('end');
                        }
                        
                        allResults = [...allResults, ...responseData.data];
                        renderJsonResponse(allResults, endpoint);
                        currentPage++;
                    } else {
                        renderJsonResponse(responseData.data, endpoint);
                    }
                } else {
                    renderJsonResponse({ error: responseData.msg });
                }
            } catch (error) {
                renderJsonResponse({ error: error.message });
            } finally {
                if (reset) {
                    sendButton.disabled = false;
                    sendButton.innerText = '发送请求';
                }
                isLoading = false;
                loadMoreElement.classList.remove('loading');
            }
        }
        
        // 渲染响应数据
        function renderJsonResponse(data, endpoint = '') {
            const responseElement = document.getElementById('response');
            
            if (typeof data === 'string') {
                responseElement.innerHTML = `<pre style="color: #e53e3e; margin: 0;">${escapeHtml(data)}</pre>`;
                return;
            }
            
            // 短信查询结果
            if (endpoint === '/sms/query') {
                if (data.length === 0) {
                    responseElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">没有找到短信记录</div>';
                    return;
                }
                
                const html = data.map(item => {
                    const date = new Date(item.date).toLocaleString();
                    let simInfo = '未知卡槽';
                    if (item.sim_id === 0) simInfo = 'SIM卡1';
                    else if (item.sim_id === 1) simInfo = 'SIM卡2';
                    
                    return `
                        <div class="record-card">
                            <div class="record-header">
                                <span class="record-sim">${simInfo}</span>
                                <span style="color: #718096; font-size: 12px;">${date}</span>
                            </div>
                            <div class="record-content">${escapeHtml(item.content)}</div>
                            <div class="record-meta">
                                <span>${escapeHtml(item.name || '未知联系人')} ${escapeHtml(item.number)}</span>
                                <span class="record-action" onclick="replySMS('${escapeHtml(item.number)}')">回复</span>
                            </div>
                        </div>
                    `;
                }).join('');
                responseElement.innerHTML = html;
                return;
            }
            
            // 通话查询结果
            if (endpoint === '/call/query') {
                if (data.length === 0) {
                    responseElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">没有找到通话记录</div>';
                    return;
                }
                
                const html = data.map(item => {
                    const date = new Date(item.dateLong).toLocaleString();
                    const duration = `${Math.floor(item.duration / 60)}分${item.duration % 60}秒`;
                    let typeText = item.type === 1 ? '呼入' : item.type === 2 ? '呼出' : '未接';
                    let typeColor = item.type === 1 ? '#48bb78' : item.type === 2 ? '#4299e1' : '#e53e3e';
                    
                    return `
                        <div class="record-card">
                            <div class="record-header">
                                <span style="color: ${typeColor}; font-size: 12px; font-weight: 600;">${typeText}</span>
                                <span style="color: #718096; font-size: 12px;">${date}</span>
                            </div>
                            <div class="record-content">${escapeHtml(item.name || '未知联系人')} ${escapeHtml(item.number)}</div>
                            <div class="record-meta">
                                <span>通话时长: ${duration}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                responseElement.innerHTML = html;
                return;
            }
            
            // 配置查询结果
            if (endpoint === '/config/query') {
                const allFeatures = [
                    { key: 'enable_api_sms_send', label: '发送短信', icon: 'fas fa-comment-dots' },
                    { key: 'enable_api_sms_query', label: '查询短信', icon: 'fas fa-history' },
                    { key: 'enable_api_call_query', label: '查询通话', icon: 'fas fa-phone' },
                    { key: 'enable_api_battery_query', label: '查询电量', icon: 'fas fa-battery-full' },
                    { key: 'enable_api_wol', label: '远程WOL', icon: 'fas fa-power-off' },
                    { key: 'enable_api_clone', label: '一键换机', icon: 'fas fa-clone' },
                    { key: 'enable_api_contact_query', label: '查询话簿', icon: 'fas fa-address-book' },
                    { key: 'enable_api_location', label: '查询定位', icon: 'fas fa-map-marker-alt' }
                ];
                
                const html = `
                    <div class="config-card">
                        <div class="config-header">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">设备配置信息</h3>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                <span style="background: #e8f4f8; color: #4299e1; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    ${data.extra_device_mark || '未知设备'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <h4 style="margin: 0 0 12px 0; color: #4a5568; font-size: 14px;">功能状态</h4>
                            <div class="status-grid">
                                ${allFeatures.map(feature => `
                                    <div class="status-item ${data[feature.key] ? 'active' : 'inactive'}">
                                        <i class="${feature.icon}"></i>
                                        <span>${feature.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <h4 style="margin: 0 0 12px 0; color: #4a5568; font-size: 14px;">SIM卡信息</h4>
                            <div class="sim-cards">
                                ${Object.values(data.sim_info_list || {}).map(sim => `
                                    <div class="sim-card">
                                        <div class="sim-header">
                                            <i class="fas fa-sim-card"></i>
                                            <span>${sim.carrier_name || '未知运营商'}</span>
                                        </div>
                                        <div class="sim-number">${sim.number || '未知号码'}</div>
                                        <div class="sim-icc">ICCID: ${sim.icc_id || '未知'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                responseElement.innerHTML = html;
                return;
            }
            
            // 电量查询结果
            if (endpoint === '/battery/query') {
                const batteryLevel = parseInt(data.level) || 0;
                const batteryColor = batteryLevel > 70 ? '#48bb78' : batteryLevel > 30 ? '#f7941d' : '#e53e3e';
                
                const html = `
                    <div class="battery-card">
                        <div class="battery-header">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">电池信息</h3>
                        </div>
                        
                        <div class="battery-level">
                            <div class="battery-progress">
                                <div class="battery-fill" style="width: ${batteryLevel}%; background: ${batteryColor};"></div>
                                <div class="battery-text">${batteryLevel}%</div>
                            </div>
                        </div>
                        
                        <div class="battery-details">
                            <div class="detail-item">
                                <span class="detail-label">状态:</span>
                                <span class="detail-value">${data.status || '未知'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">健康度:</span>
                                <span class="detail-value">${data.health || '未知'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">充电器:</span>
                                <span class="detail-value">${data.plugged || '未知'}</span>
                            </div>
                            ${data.temperature ? `
                            <div class="detail-item">
                                <span class="detail-label">温度:</span>
                                <span class="detail-value">${data.temperature}</span>
                            </div>
                            ` : ''}
                            ${data.voltage ? `
                            <div class="detail-item">
                                <span class="detail-label">电压:</span>
                                <span class="detail-value">${data.voltage}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                responseElement.innerHTML = html;
                return;
            }
            
            // 定位查询结果
            if (endpoint === '/location/query') {
                const latitude = data.latitude || '';
                const longitude = data.longitude || '';
                
                const html = `
                    <div class="location-card">
                        <div class="location-header">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">位置信息</h3>
                        </div>
                        
                        <div class="location-details">
                            <div class="detail-item">
                                <i class="fas fa-map-marker-alt" style="color: #e53e3e;"></i>
                                <span class="detail-value">${data.address || '未知地址'}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-globe" style="color: #4299e1;"></i>
                                <span class="detail-value">纬度: ${latitude || '未知'}, 经度: ${longitude || '未知'}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-clock" style="color: #718096;"></i>
                                <span class="detail-value">更新时间: ${data.time || '未知'}</span>
                            </div>
                            ${data.provider ? `
                            <div class="detail-item">
                                <i class="fas fa-satellite" style="color: #48bb78;"></i>
                                <span class="detail-value">定位方式: ${data.provider}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${latitude && longitude ? `
                        <div class="map-links" style="margin-top: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #4a5568; font-size: 14px;">在地图中查看</h4>
                            <div class="map-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <a href="https://maps.google.com/?q=${latitude},${longitude}" target="_blank" 
                                   class="map-button" style="background: #4285f4; color: white; padding: 10px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 13px;">
                                    <i class="fas fa-map"></i> Google地图
                                </a>
                                <a href="https://api.map.baidu.com/marker?location=${latitude},${longitude}&title=当前位置&content=${encodeURIComponent(data.address || '')}&output=html" target="_blank"
                                   class="map-button" style="background: #2932e1; color: white; padding: 10px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 13px;">
                                    <i class="fas fa-map"></i> 百度地图
                                </a>
                                <a href="https://uri.amap.com/marker?position=${longitude},${latitude}&name=当前位置" target="_blank"
                                   class="map-button" style="background: #0091ff; color: white; padding: 10px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 13px;">
                                    <i class="fas fa-map"></i> 高德地图
                                </a>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                responseElement.innerHTML = html;
                return;
            }
            
            // 联系人查询结果
            if (endpoint === '/contact/query') {
                if (data.length === 0) {
                    responseElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">没有找到联系人</div>';
                    return;
                }
                
                const html = data.map(contact => `
                    <div class="contact-card">
                        <div class="contact-header">
                            <i class="fas fa-user" style="color: #4299e1; font-size: 18px;"></i>
                            <span style="font-weight: 600; color: #2d3748;">${escapeHtml(contact.name || '未知联系人')}</span>
                        </div>
                        <div class="contact-number">${escapeHtml(contact.phone_number)}</div>
                        <div class="contact-actions">
                            <span class="record-action" onclick="sendSMS('${escapeHtml(contact.phone_number)}')">发送短信</span>
                            <span class="record-action" onclick="callNumber('${escapeHtml(contact.phone_number)}')">拨打电话</span>
                        </div>
                    </div>
                `).join('');
                responseElement.innerHTML = html;
                return;
            }
            
            // 默认JSON格式化
            responseElement.innerHTML = formatJson(data);
        }
        
        // JSON格式化
        function formatJson(json, indent = 0) {
            if (json === null) return '<span class="json-null">null</span>';
            if (typeof json === 'boolean') return `<span class="json-boolean">${json}</span>`;
            if (typeof json === 'number') return `<span class="json-number">${json}</span>`;
            if (typeof json === 'string') return `<span class="json-string">"${escapeHtml(json)}"</span>`;
            
            if (Array.isArray(json)) {
                if (json.length === 0) return '[ ]';
                let html = '[<br>';
                json.forEach((item, i) => {
                    html += `<span class="json-indent" style="margin-left: ${indent + 20}px;">`;
                    html += formatJson(item, indent + 20);
                    html += i < json.length - 1 ? ',<br>' : '<br>';
                    html += '</span>';
                });
                html += `<span style="margin-left: ${indent}px;">]</span>`;
                return html;
            }
            
            const keys = Object.keys(json);
            if (keys.length === 0) return '{ }';
            let html = '{<br>';
            keys.forEach((key, i) => {
                html += `<span class="json-indent" style="margin-left: ${indent + 20}px;">`;
                html += `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                html += formatJson(json[key], indent + 20);
                html += i < keys.length - 1 ? ',<br>' : '<br>';
                html += '</span>';
            });
            html += `<span style="margin-left: ${indent}px;">}</span>`;
            return html;
        }
        
        // 回复短信
        function replySMS(number) {
            document.querySelectorAll('.grid-item').forEach(item => {
                if (item.dataset.value === '/sms/send') {
                    item.click();
                    setTimeout(() => {
                        document.getElementById('phone_numbers').value = number;
                    }, 100);
                }
            });
        }
        
        // 发送短信给指定号码
        function sendSMS(number) {
            document.querySelectorAll('.grid-item').forEach(item => {
                if (item.dataset.value === '/sms/send') {
                    item.click();
                    setTimeout(() => {
                        document.getElementById('phone_numbers').value = number;
                    }, 100);
                }
            });
        }
        
        // 拨打电话
        function callNumber(number) {
            alert(`拨打电话功能: ${number}\n\n注意: 此功能需要设备支持电话拨号功能。`);
        }
        
        // 生成签名
        async function generateSign(timestamp, key) {
            const message = `${timestamp}\n${key}`;
            const enc = new TextEncoder();
            const keyData = enc.encode(key);
            const cryptoKey = await crypto.subtle.importKey("raw", keyData, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]);
            const signature = await crypto.subtle.sign("HMAC", cryptoKey, enc.encode(message));
            return encodeURIComponent(btoa(String.fromCharCode(...new Uint8Array(signature))));
        }
        
        // HTML转义
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 滚动加载
        function setupScrollLoading() {
            const resultContainer = document.getElementById('response');
            resultContainer.addEventListener('scroll', () => {
                if (!['/sms/query', '/call/query'].includes(currentEndpoint)) return;
                if (resultContainer.scrollTop + resultContainer.clientHeight >= resultContainer.scrollHeight - 200) {
                    if (!isLoading && hasMoreData) sendRequest(false);
                }
            });
        }
        
        // 初始化滚动加载
        setupScrollLoading();
    </script>
</body>
</html>
